# Openresty / Certbot

## üìÑ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

- –ó–∞–º–µ–Ω–∏—Ç—å Nginx Proxy Manager –Ω–∞ "–≤–∞–Ω–∏–ª—å–Ω—ã–π" Openresty, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å Openresty –≤ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
- –û–±–µ—Å–ø–µ—á–∏—Ç—å –≤—ã–ø—É—Å–∫ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ X.509 SSL/TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ certbot —Å http –∏–ª–∏ dns –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π (—á–µ—Ä–µ–∑ DNS Cloudflare).
- –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ certbot –¥–æ–ª–∂–µ–Ω –≤—ã–ø—É—Å—Ç–∏—Ç—å.
- –ù–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å certbot –¥–æ—Å—Ç—É–ø–∞ –∫ docker.sock –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Openresty –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.
- –ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å Openresty –∏ certbot –≤ –æ–¥–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (—Ç.–∫. —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)

## üìò –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Openresty

–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è, –ø—Ä–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–∏ —Å–ª–µ–¥—É—é—â–∏—Ö —É—Å–ª–æ–≤–∏–π:

1. –í nginx.conf –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω endpoint –¥–ª—è healtcheck
2. –í nginx.conf –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω endpoint –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Openresty
3. –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–æ–≤, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è http –≤–∞–ª–∏–¥–∞—Ü–∏—è LetsEncrypt, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω include acme-proxy.conf

> NOTE: Openresty –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Supervisor. –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ openresty —á–µ—Ä–µ–∑ Reload Endpoint

## üìò –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Certbot: `certs.yaml`

–§–∞–π–ª `/config/certbot/certs.yaml` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ SSL/TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø—É—Å–∫–∞—é—Ç—Å—è –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é `certbot_agent.sh`.

–û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º Certbot –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π, –∞ —Ç–∞–∫–∂–µ –¥–ª—è –∏—Ö –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è post-hook –¥–µ–π—Å—Ç–≤–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Openresty).

---

### üß© –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```yaml
certificates:
  - name: <—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ_–∏–º—è_—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞>
    domains:
      - example.com
      - www.example.com
    validation: <dns|http>
    dns_plugin: <–∏–º—è_–ø–ª–∞–≥–∏–Ω–∞_certbot_dns>               # (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ http –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
    credentials_file: <–ø—É—Ç—å_–∫_—Ñ–∞–π–ª—É_—Å_—É—á—ë—Ç–Ω—ã–º–∏_–¥–∞–Ω–Ω—ã–º–∏> # (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ http –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
    email: <email_–¥–ª—è_—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π_LetsEncrypt>
    staging: <true|false>
    post_hook: <–∏–º—è_—Å–∫—Ä–∏–ø—Ç–∞_–∏–ª–∏_–∫–æ–º–∞–Ω–¥–∞>                # (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    post_hook_args: <–∞—Ä–≥—É–º–µ–Ω—Ç—ã_–¥–ª—è_post_hook>           # (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    extra_args: <–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ_–∞—Ä–≥—É–º–µ–Ω—Ç—ã_certbot>      # (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
```

---

### üß± –ü–æ–ª—è

#### `name` *(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)*  
–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.  
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏–º—è –∫–∞—Ç–∞–ª–æ–≥–∞ –≤ `/etc/letsencrypt/live/<name>/`.

**–ü—Ä–∏–º–µ—Ä:**
```yaml
name: example.com
```

---

#### `domains` *(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)*  
–°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤, –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç.

**–ü—Ä–∏–º–µ—Ä:**
```yaml
domains:
  - example.com
  - www.example.com
```

---

#### `validation` *(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)*  
–¢–∏–ø –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤–ª–∞–¥–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–º.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
- `dns` ‚Äî DNS-–≤–∞–ª–∏–¥–∞—Ü–∏—è (—á–µ—Ä–µ–∑ API –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞)
- `http` ‚Äî HTTP-–≤–∞–ª–∏–¥–∞—Ü–∏—è (—á–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π standalone-—Å–µ—Ä–≤–µ—Ä Certbot)

**–ü—Ä–∏–º–µ—Ä:**
```yaml
validation: dns
```

> –î–ª—è HTTP –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Openresty –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ certbot:8080, –µ—Å–ª–∏ –≤ –∫–æ–Ω—Ñ–∏–≥–µ Openresty –≤—ã–ø–æ–ª–Ω–µ–Ω include acme_proxy.conf. –ë–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Openresty –≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥ 80:8080 –≤ docker-compose.yaml –∏ –ø—Ä–æ–π—Ç–∏ http –≤–∞–ª–∏–¥–∞—Ü–∏—é

---

#### `dns_plugin`  
–ò–º—è DNS-–ø–ª–∞–≥–∏–Ω–∞ Certbot, –Ω–∞–ø—Ä–∏–º–µ—Ä:
- `cloudflare` 

> –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `validation: dns`.

> –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ cloudflare

**–ü—Ä–∏–º–µ—Ä:**
```yaml
dns_plugin: cloudflare
```

---

#### `credentials_file`  
–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å API-–∫–ª—é—á–æ–º DNS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.  
–§–æ—Ä–º–∞—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞.

**–ü—Ä–∏–º–µ—Ä:**
```yaml
credentials_file: /certbot/credentials/cloudflare.ini
```

---

#### `email`  
Email, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ Let's Encrypt.  

**–ü—Ä–∏–º–µ—Ä:**
```yaml
email: le@example.com
```

---

#### `staging`  
–§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä Let's Encrypt (`--staging`).  
–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∞—Ç—å –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ, —á—Ç–æ–±—ã –Ω–µ –¥–æ—Å—Ç–∏—á—å –ª–∏–º–∏—Ç–∞ –≤—ã–ø—É—Å–∫–æ–≤.

**–ü—Ä–∏–º–µ—Ä:**
```yaml
staging: true
```

---

#### `post_hook`  
–°–∫—Ä–∏–ø—Ç –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º–∞—è **–ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞** –∏ **–ø–æ—Å–ª–µ –≤—ã–ø—É—Å–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞**.

–ú–æ–∂–µ—Ç –±—ã—Ç—å:
1. –ò–º—è –∏—Å–ø–æ–ª–Ω–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/posthooks`
2. –õ—é–±–∞—è shell-–∫–æ–º–∞–Ω–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä `systemctl reload nginx`)

**–ü—Ä–∏–º–µ—Ä—ã:**
```yaml
post_hook: reload_Openresty.sh
```

–∏–ª–∏

```yaml
post_hook: curl http://openrestry:8081/reload
```

---

#### `post_hook_args` *(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)*  
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ post-hook —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏.

**–ü—Ä–∏–º–µ—Ä:**
```yaml
post_hook_args: "--graceful"
```

---

#### `extra_args` *(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)*  
–ü–æ–∑–≤–æ–ª—è–µ—Ç —É–∫–∞–∑–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Certbot –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.  
–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–π, —Ü–µ–ø–æ—á–µ–∫ –∏ —Ç.–ø.

**–ü—Ä–∏–º–µ—Ä—ã:**
```yaml
extra_args: "--preferred-chain ISRG Root X1"
```

–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ:
```yaml
extra_args: "--key-type rsa --rsa-key-size 4096"
```

---

### üìÑ –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä

```yaml
certificates:
  - name: 21.le-testing.example.org
    domains:
      - 21.le-testing.example.org
    validation: http
    staging: true
    email: le@example.org
    post_hook: reload_Openresty.sh

  - name: 22-23.le-testing.example.org
    domains:
      - 22.le-testing.example.org
      - 23.le-testing.example.org
    validation: dns
    dns_plugin: cloudflare
    credentials_file: /certbot/credentials/cloudflare.ini
    staging: true
    email: le@example.org
    post_hook: reload_Openresty.sh
    extra_args: "--key-type ecdsa --elliptic-curve secp384r1"
```

---

### üí° –ü–æ–≤–µ–¥–µ–Ω–∏–µ Certbot

- –ï—Å–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç **—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç**, –ø–µ—Ä–µ–≤—ã–ø—É—Å–∫ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.
- –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–æ–ª—è (`domains`, `validation`, `dns_plugin`, `credentials_file`, `email`, `extra_args`), –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–ø–µ—Ä–µ–≤—ã–ø—É—Å–∫**.
- –ï—Å–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É–¥–∞–ª—ë–Ω –∏–∑ YAML, –æ–Ω –±—É–¥–µ—Ç **—É–¥–∞–ª—ë–Ω –∏–∑ /etc/letsencrypt**.
- –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–ª–∏ –≤—ã–ø—É—Å–∫–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É–∫–∞–∑–∞–Ω–Ω—ã–π `post_hook`.